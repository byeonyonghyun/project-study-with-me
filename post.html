<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ëª¨ì§‘ ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container mt-5">

<h2 class="mb-4">ğŸ“„ ëª¨ì§‘ ê¸€ ìƒì„¸</h2>

<!-- ê²Œì‹œê¸€ ìƒì„¸ ì¶œë ¥ ì˜ì—­ -->
<div id="postDetail"></div>

<!-- ë²„íŠ¼ ì˜ì—­ -->
<div class="mt-4">
    <button id="applyBtn" class="btn btn-success mt-3">ğŸ™‹ ì§€ì›í•˜ê¸°</button>
    <button id="editBtn" class="btn btn-warning" style="display:none;">âœï¸ ìˆ˜ì •í•˜ê¸°</button>
    <button id="deleteBtn" class="btn btn-danger" style="display:none;">ğŸ—‘ ì‚­ì œí•˜ê¸°</button>
    <a href="/board.html" class="btn btn-secondary">â¬… ê²Œì‹œíŒìœ¼ë¡œ</a>
    <a href="/main.html" class="btn btn-outline-primary">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>
</div>

<!-- ìŠ¤í¬ë¦½íŠ¸ ì˜ì—­ -->
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('id');

    if (!postId) {
        alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
        window.location.href = "/board.html";
    }

    let postData;  // ê²Œì‹œê¸€ ë°ì´í„° ì €ì¥ìš©

    // âœ… ê²Œì‹œê¸€ ì¡°íšŒ ë° ë²„íŠ¼ í‘œì‹œ ì œì–´
    fetch(`/posts/${postId}`)
        .then(response => {
            if (!response.ok) throw new Error("ê²Œì‹œê¸€ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return response.json();
        })
        .then(post => {
            postData = post;

            // ìƒì„¸ ë‚´ìš© ì¶œë ¥
            document.getElementById("postDetail").innerHTML = `
                <h3>${post.title}</h3>
                <p><strong>ë¶„ì•¼:</strong> ${post.category}</p>
                <p><strong>ì§„í–‰ ë°©ì‹:</strong> ${post.progressType} ${post.region ? '(' + post.region + ')' : ''}</p>
                <p><strong>ëª¨ì§‘ ì¸ì›:</strong> ${post.recruitNum}</p>
                <p><strong>ì§„í–‰ ìš”ì¼:</strong> ${post.days || 'ë¯¸ì •'}</p>
                <p><strong>ì‹œê°„ëŒ€:</strong> ${post.timeSlot || 'ë¯¸ì •'}</p>
                <p><strong>ë§ˆê°ì¼:</strong> ${post.deadline || 'ì—†ìŒ'}</p>
                <p><strong>íƒœê·¸:</strong> ${post.tags || 'ì—†ìŒ'}</p>
                <p><strong>ìƒíƒœ:</strong> ${post.status}</p>
                <hr>
                <p>${post.content.replaceAll('\n', '<br>')}</p>
                <p class="text-end text-muted">ì‘ì„±ì¼: ${post.createdAt}</p>
            `;

            // ë³¸ì¸ ê¸€ì¼ ê²½ìš° ë²„íŠ¼ ì œì–´
            fetch('/users/me')
                .then(res => res.json())
                .then(user => {
                    if (user.id === post.author.id) {
                        document.getElementById("applyBtn").style.display = "none";
                        document.getElementById("editBtn").style.display = "inline-block";
                        document.getElementById("deleteBtn").style.display = "inline-block";
                    }
                });
        })
        .catch(err => {
            alert(err.message);
            window.location.href = "/board.html";
        });

    // âœ… ì§€ì›í•˜ê¸° ê¸°ëŠ¥
    document.getElementById("applyBtn").addEventListener("click", function() {
        if (confirm("ì´ ëª¨ì§‘ê¸€ì— ì§€ì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            fetch(`/notifications/apply/${postId}`, { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        alert("âœ… ì§€ì› ì™„ë£Œ! ì‘ì„±ìì—ê²Œ ì•Œë¦¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        document.getElementById("applyBtn").disabled = true;
                    } else {
                        alert("âŒ ì§€ì› ì‹¤íŒ¨ (ì´ë¯¸ ì§€ì›í–ˆê±°ë‚˜ ì˜¤ë¥˜)");
                    }
                });
        }
    });

    // âœ… ì‚­ì œ ê¸°ëŠ¥
    document.getElementById("deleteBtn").addEventListener("click", function() {
        if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            fetch(`/posts/${postId}`, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        alert("âœ… ì‚­ì œ ì™„ë£Œ");
                        window.location.href = "/board.html";
                    } else {
                        alert("âŒ ì‚­ì œ ì‹¤íŒ¨");
                    }
                });
        }
    });
</script>

</body>
</html>
